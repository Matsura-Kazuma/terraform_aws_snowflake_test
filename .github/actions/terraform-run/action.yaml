name: Terraform Runï¼ˆCompositeï¼‰
description: OIDC + SOPS + init
inputs:
  stack:
    required: true
  role_arn:
    required: true
  region:
    required: true
runs:
  using: composite
  steps:
    - uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ inputs.role_arn }}
        aws-region: ${{ inputs.region }}
    - shell: bash
      run: |
        echo "${{ secrets.SOPS_AGE_KEY }}" > /tmp/agekey.txt
        export SOPS_AGE_KEY_FILE=/tmp/agekey.txt
        if [ -f "${{ inputs.stack }}/secrets.enc.tfvars" ]; then
          sops -d "${{ inputs.stack }}/secrets.enc.tfvars" > "${{ inputs.stack }}/secrets.dec.tfvars"
        fi
        terraform -chdir=${{ inputs.stack }} init -backend-config=${{ inputs.stack }}/backend.hcl
